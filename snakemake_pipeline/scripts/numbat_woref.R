# ------------------------------------------------------------------------------
# Run Numbat
# ------------------------------------------------------------------------------

log <- file(snakemake@log[[1]], open="wt")
sink(log)
sink(log, type="message")

# ------------------------------------------------------------------------------
print("Load libraries")
# ------------------------------------------------------------------------------

library(numbat)
library(data.table)

# ------------------------------------------------------------------------------
print("Get input parameters from snakemake")
# ------------------------------------------------------------------------------

input_count_mat <- snakemake@input$count_mat
input_allele_path <- snakemake@input$df_allele

out_cnv_expr <- snakemake@output$cnv_expr

threads<-snakemake@threads

# ------------------------------------------------------------------------------
print("Execute Numbat")
# ------------------------------------------------------------------------------

#Load dataset matrix (annotation file not required in this modus)
data_matrix<-fread(input_count_mat)
#Format into a matrix
gene_names<-data_matrix$V1
data_matrix$V1<-NULL
data_matrix<-as.matrix(data_matrix)
rownames(data_matrix)<-gene_names

#Read input AF file
df_allele<-fread(input_allele_path)

out = run_numbat(
  data_matrix, # gene x cell integer UMI count matrix 
  numbat::ref_hca, # reference expression profile, a gene x cell type normalized expression level matrix
  df_allele, # allele dataframe generated by pileup_and_phase script
  genome = "hg38",
  t = 1e-5,
  ncores = threads,
  plot = TRUE,
  out_dir = dirname(out_cnv_expr)
)

# ------------------------------------------------------------------------------
print("SessionInfo:")
# ------------------------------------------------------------------------------
sessionInfo()
